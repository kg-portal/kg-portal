{% extends "base.html" %}
{% block content %}

<!--
..........................................................................................................
..........................................................................................................
.......... üü¶ √úST B√ñL√úM: SAYFA BA≈ûLIƒûI VE ANA BUTONLAR (YAZDIRMA & EKLEME) ...............................
..........................................................................................................
..........................................................................................................
-->

<div class="no-print" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:32px">
  <div>
    <h1 style="font-size:32px;font-weight:900;color:#16a34a;margin:0;letter-spacing:-1px">
      Bestandskunden
    </h1>
    <p style="color:#2563eb;font-size:15px;margin:6px 0 0 0;font-weight:700">
      Zentrale Verwaltung der Kundenstamm- und Vertragsdaten
    </p>
  </div>
  <div style="display:flex; gap:12px;">
    <button onclick="window.print()"
            style="background:#f1f5f9;color:#475569;border:1px solid #e2e8f0;
                   padding:12px 20px;border-radius:12px;font-weight:700;cursor:pointer">
      <i class="fa-solid fa-print"></i> Liste Drucken
    </button>
    <button onclick="openNewModal()"
            style="background:#2563eb;color:#fff;border:none;padding:12px 24px;
                   border-radius:12px;font-weight:700;cursor:pointer;
                   box-shadow:0 10px 15px -3px rgba(37,99,235,0.3)">
      + Neuer Kunde
    </button>
  </div>
</div>


<!--
..........................................................................................................
..........................................................................................................
.......... ‚¨ú ANA Lƒ∞STE: M√ú≈ûTERƒ∞LERƒ∞N SIRALANDIƒûI TABLO ALANI ............................................
..........................................................................................................
..........................................................................................................
-->

<div id="main_list" class="print-area"
     style="background:#fff;border:1px solid #e2e8f0;border-radius:20px;
            overflow:hidden;box-shadow:0 20px 25px -5px rgba(0,0,0,0.05)">

  <table style="width:100%;border-collapse:collapse;text-align:left">

    <thead style="background:#f8fafc;border-bottom:2px solid #f1f5f9">
      <tr>
        <th style="padding:20px;font-weight:900;font-size:13px;color:#000">FIRMA</th>
        <th style="padding:20px;font-weight:900;font-size:13px;color:#000">STRA√üE + NR.</th>
        <th style="padding:20px;font-weight:900;font-size:13px;color:#000">PLZ</th>
        <th style="padding:20px;font-weight:900;font-size:13px;color:#000">STADT</th>
        <th style="padding:20px;font-weight:900;font-size:13px;color:#000">KUNDENNUMMER</th>
        <th style="padding:20px;font-weight:900;font-size:13px;color:#000">H√ÑUFIGKEIT</th>

        <!-- ‚úÖ SIRA D√úZELTƒ∞LDƒ∞ -->
        <th style="padding:20px;font-weight:900;font-size:13px;color:#000">BEGINN</th>
        <th style="padding:20px;font-weight:900;font-size:13px;color:#000">ENDE</th>
        <th style="padding:20px;font-weight:900;font-size:13px;color:#000">VERTRAGSLAUFZEIT</th>
        <th style="padding:20px;font-weight:900;font-size:13px;color:#000">VERTRAGSSTATUS</th>

        <th style="padding:20px;font-weight:900;font-size:13px;color:#000">BETRAG (‚Ç¨)</th>
        <th class="no-print" style="padding:20px;text-align:right;font-weight:900;color:#000">
          AKTIONEN
        </th>
      </tr>
    </thead>

    <tbody>
      {% for k in kunden %}
      <tr id="row-{{ k.id }}" style="border-bottom:1px solid #f1f5f9">

        <td style="padding:20px;font-weight:800;color:#1e293b">{{ k.firma }}</td>
        <td style="padding:20px;color:#64748b">{{ k.strasse }}</td>
        <td style="padding:20px;color:#64748b">{{ k.plz }}</td>
        <td style="padding:20px;color:#64748b">{{ k.ort }}</td>

        <td style="padding:20px">
          <span style="background:#f1f5f9;padding:6px 12px;border-radius:8px;
                       font-family:monospace;color:#2563eb">
            {{ k.kundennummer }}
          </span>
        </td>

        <td style="padding:20px">
          <span style="color:#6366f1;background:#eef2ff;padding:6px 14px;
                       border-radius:30px;font-size:12px;font-weight:700">
            {{ k.haeufigkeit }}
          </span>
        </td>

        <!-- BEGINN -->
        <td style="padding:20px;color:#475569">{{ k.vertrag_beginn }}</td>

        <!-- ENDE -->
        <td style="padding:20px;color:#475569">{{ k.vertrag_ende }}</td>

        <!-- VERTRAGSLAUFZEIT -->
        <td style="padding:20px;font-weight:800;
          color:{% if k.vertragslaufzeit == 'unbefristet' %}#16a34a{% else %}#f97316{% endif %}">
          {{ "Unbefristet" if k.vertragslaufzeit == "unbefristet" else "Befristet" }}
        </td>

        <!-- VERTRAGSSTATUS -->
        <td style="padding:20px;font-weight:800;
          color:{% if k.vertragsstatus == 'gekuendigt' %}#dc2626{% else %}#16a34a{% endif %}">
          {{ "Gek√ºndigt" if k.vertragsstatus == "gekuendigt" else "Aktuell" }}
        </td>

        <td style="padding:20px;font-weight:800;color:#059669">
          {{ "{:,.2f}".format(k.monat).replace(",", "X").replace(".", ",").replace("X", ".") if k.monat else "0,00" }} ‚Ç¨
        </td>

 <td class="no-print"
    style="padding:20px;
           height:72px;
           display:flex;
           align-items:center;
           justify-content:flex-end;
           gap:8px">

  <button onclick="previewKunde('{{ k.id }}')" title="Vorschau"
          style="background:#eef2ff;color:#6366f1;border:none;
                 width:38px;height:38px;border-radius:10px">
    <i class="fa-solid fa-eye"></i>
  </button>

  <button onclick="editKunde('{{ k.id }}')" title="Bearbeiten"
          style="background:#f0fdf4;color:#16a34a;border:none;
                 width:38px;height:38px;border-radius:10px">
    <i class="fa-solid fa-pen-to-square"></i>
  </button>

  <button onclick="if(confirm('Kunde wirklich l√∂schen?')) window.location.href='/kunden/delete/{{ k.id }}'"
          title="L√∂schen"
          style="background:#fef2f2;color:#dc2626;border:none;
                 width:38px;height:38px;border-radius:10px">
    <i class="fa-solid fa-trash"></i>
  </button>

<!-- ‚úÖ SADECE ƒ∞LGƒ∞Lƒ∞ D√úZELTME: JS'ƒ∞N ARADIƒûI .t-* VERƒ∞LERƒ∞ (Gƒ∞ZLƒ∞) -->
<div style="display:none">
  <span class="t-firma">{{ k.firma }}</span>
  <span class="t-strasse">{{ k.strasse }}</span>
  <span class="t-plz">{{ k.plz }}</span>
  <span class="t-ort">{{ k.ort }}</span>

  <span class="t-name">{{ k.ansprechpartner_name or "" }}</span>
  <span class="t-tel">{{ k.telefon or "" }}</span>
  <span class="t-mail">{{ k.email or "" }}</span>

  <span class="t-knr">{{ k.kundennummer }}</span>
  <span class="t-freq">{{ k.haeufigkeit }}</span>

  <span class="t-beginn">{{ k.vertrag_beginn }}</span>
  <span class="t-ende">{{ k.vertrag_ende }}</span>

  <span class="t-laufzeit">{{ k.vertragslaufzeit or "unbefristet" }}</span>
  <span class="t-status">{{ k.vertragsstatus or "aktuell" }}</span>

  <span class="t-raw-monat">{{ k.monat if k.monat else "" }}</span>
  <span class="t-monat">
    {{ "{:,.2f}".format(k.monat).replace(",", "X").replace(".", ",").replace("X", ".") if k.monat else "0,00" }} ‚Ç¨
  </span>
</div>
<!-- ‚úÖ SADECE ƒ∞LGƒ∞Lƒ∞ D√úZELTME Bƒ∞TTƒ∞ -->

</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>



<!--
..........................................................................................................
..........................................................................................................
.......... üüß KAYIT FORMU: YENƒ∞ M√ú≈ûTERƒ∞ EKLEME VE D√úZENLEME EKRANI (MODAL) ...............................
..........................................................................................................
..........................................................................................................
-->

<div id="km" style="display:none;position:fixed;inset:0;background:rgba(15,23,42,0.8);backdrop-filter:blur(10px);align-items:center;justify-content:center;z-index:1000">
  <form action="/kunden" method="POST" id="kundenForm"
        style="background:#fff;width:2150px;max-width:99%;
               border-radius:28px;padding:72px;
               box-shadow:0 25px 50px -12px rgba(0,0,0,0.5)">

    <input type="hidden" name="kunde_id" id="f_id">

    <!-- BA≈ûLIK -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:36px">
      <h2 id="modalTitle"
          style="font-size:28px;font-weight:900;color:#2563eb;margin:0">
        Kunden-Stammdaten
      </h2>
      <button type="button" onclick="closeModal()"
              style="background:#f1f5f9;border:none;width:36px;height:36px;border-radius:50%;cursor:pointer;font-weight:bold">‚úï</button>
    </div>

    <!-- FIRMEN -->
    <div style="margin-bottom:28px">
      <label class="blue-label" style="color:#2563eb">FIRMENINFORMATIONEN</label>
      <div style="display:grid;grid-template-columns:1.5fr 1fr 0.8fr 1.2fr;gap:22px">
        <div>
          <label class="input-lbl" style="color:#2563eb">Firma</label>
          <input class="m-input" name="firma" id="f_firma" required>
        </div>
        <div>
          <label class="input-lbl" style="color:#2563eb">Stra√üe + Nr.</label>
          <input class="m-input" name="strasse" id="f_strasse">
        </div>
        <div>
          <label class="input-lbl" style="color:#2563eb">PLZ</label>
          <input class="m-input" name="plz" id="f_plz" oninput="autoCityNRW()">
        </div>
        <div>
          <label class="input-lbl" style="color:#2563eb">Stadt</label>
          <input class="m-input" name="stadt" id="f_stadt" readonly>
        </div>
      </div>
    </div>

    <!-- ANSPRECHPARTNER -->
<div style="margin-bottom:28px">
  <label class="blue-label" style="color:#2563eb">ANSPRECHPARTNER</label>

  <!-- HERR / FRAU -->
  <div style="display:flex;gap:20px;margin:10px 0 14px 0">
    <label>
      <input type="radio" name="anrede" value="Herr"> Herr
    </label>
    <label>
      <input type="radio" name="anrede" value="Frau"> Frau
    </label>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:22px">
    <div>
      <label class="input-lbl" style="color:#2563eb">Name</label>
      <input class="m-input" name="name" id="f_name">
    </div>
    <div>
      <label class="input-lbl" style="color:#2563eb">Telefon</label>
      <input class="m-input" name="telefon" id="f_tel">
    </div>
    <div>
      <label class="input-lbl" style="color:#2563eb">E-Mail</label>
      <input class="m-input" name="email" id="f_mail">
    </div>
  </div>
</div>


    <!-- VERTRAG -->
    <div style="margin-bottom:36px">
      <label class="blue-label" style="color:#2563eb">VERTRAGS- & TERMINDETAILS</label>

      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:22px">
        <div>
          <label class="input-lbl" style="color:#2563eb">Kundennummer</label>
          <input class="m-input" name="kundennummer" id="f_knr">
        </div>

        <div>
          <label class="input-lbl" style="color:#2563eb">Beginn</label>
          <div style="position:relative">
            <input type="text" class="m-input date-picker" name="beginn" id="f_beginn" placeholder="tt.mm.jjjj">
            <i class="fa-solid fa-calendar calendar-ico"></i>
          </div>
        </div>

        <div>
          <label class="input-lbl" style="color:#2563eb">Ende</label>
          <div style="position:relative">
            <input type="text" class="m-input date-picker" name="ende" id="f_ende" placeholder="tt.mm.jjjj">
            <i class="fa-solid fa-calendar calendar-ico"></i>
          </div>
        </div>

        <div>
          <label class="input-lbl" style="color:#2563eb">Betrag (‚Ç¨)</label>
          <input class="m-input" name="betrag" id="f_monat">
        </div>
      </div>

      <!-- üÜï LAUFZEIT -->
      <div style="margin-top:26px">
        <label class="input-lbl" style="color:#2563eb;font-weight:700">
          Vertragslaufzeit
        </label>
        <div style="display:flex;gap:26px;margin-top:10px">
          <label style="display:flex;align-items:center;gap:8px">
            <input type="radio" name="laufzeit" value="unbefristet" checked>
            Unbefristet
          </label>
          <label style="display:flex;align-items:center;gap:8px">
            <input type="radio" name="laufzeit" value="befristet">
            Befristet
          </label>
        </div>
      </div>

      <!-- üÜï STATUS -->
      <div style="margin-top:22px">
        <label class="input-lbl" style="color:#2563eb;font-weight:700">
          Vertragsstatus
        </label>
        <div style="display:flex;gap:22px;margin-top:10px">
          <label style="display:flex;align-items:center;gap:8px;color:#16a34a;font-weight:600">
            <input type="radio" name="status" value="aktuell" checked>
            Aktuell
          </label>
          <label style="display:flex;align-items:center;gap:8px;color:#dc2626;font-weight:600">
            <input type="radio" name="status" value="gekuendigt">
            Gek√ºndigt
          </label>
        </div>
      </div>

      <div style="margin-top:22px">
        <label class="input-lbl" style="color:#2563eb">H√§ufigkeit</label>
        <select class="m-input" name="haeufigkeit" id="f_freq">
          <option>1√ó w√∂chentlich</option>
          <option selected>2√ó w√∂chentlich</option>
          <option>3√ó w√∂chentlich</option>
          <option>4√ó w√∂chentlich</option>
          <option>5√ó w√∂chentlich</option>
          <option>6√ó w√∂chentlich</option>
          <option>7√ó w√∂chentlich</option>
          <option>T√§glich</option>
        </select>
      </div>
    </div>

    <!-- BUTONLAR -->
    <div style="display:flex;justify-content:flex-end;gap:14px;padding-top:28px;border-top:1px solid #f1f5f9">
      <button type="button" onclick="closeModal()" class="btn-sec">Abbrechen</button>
      <button type="submit" class="btn-pri">Speichern</button>
    </div>

  </form>
</div>

<!--
..........................................................................................................
..........................................................................................................
.......... üü™ √ñNƒ∞ZLEME VE TEKLƒ∞ YAZDIRMA: M√ú≈ûTERƒ∞ DETAYLARINI G√ñRME VE BASMA ALANI .......................
..........................................................................................................
..........................................................................................................
-->

<div id="pv" style="display:none;position:fixed;inset:0;background:rgba(15,23,42,0.8);backdrop-filter:blur(10px);align-items:center;justify-content:center;z-index:1100">
    <div style="background:#fff;width:500px;border-radius:28px;padding:40px;text-align:center;" id="single_print_area">
        <h2 id="pv-firma" style="margin-bottom:20px;color:#0f172a"></h2>
        <div id="pv-details" style="text-align:left; background:#ffffff; padding:20px; border: 1px solid #e2e8f0; border-radius:12px; line-height:1.6; color:#1e293b;"></div>
        <div class="no-print" style="margin-top:20px; display:flex; gap:10px;">
            <button onclick="printSingle()" style="background:#f1f5f9; color:#475569; padding:12px; border:none; border-radius:12px; cursor:pointer; flex:1; font-weight:700;"><i class="fa-solid fa-print"></i> Einzeln Drucken</button>
            <button onclick="document.getElementById('pv').style.display='none'" style="background:#2563eb; color:#fff; padding:12px; border:none; border-radius:12px; cursor:pointer; flex:1; font-weight:700;">Schlie√üen</button>
        </div>
    </div>
</div>

<!--
..........................................................................................................
..........................................................................................................
.......... üé® STƒ∞L (CSS) AYARLARI: G√ñR√úN√úM VE YAZDIRMA D√úZENLEMELERƒ∞ .....................................
..........................................................................................................
..........................................................................................................
-->

<style>
  .m-input { width:100%;padding:14px;border:1.5px solid #e2e8f0;border-radius:12px;font-size:14px;outline:none;color:#1e293b;box-sizing:border-box }
  .input-lbl { display:block; margin-bottom:5px; font-weight:600; color:#475569; font-size:13px; }
  .calendar-ico { position:absolute;right:15px;top:15px;color:#64748b;pointer-events:none; }
  .blue-label { display:block;font-size:12px;font-weight:900;color:#2563eb;letter-spacing:1.2px;margin-bottom:15px;border-left:4px solid #2563eb;padding-left:10px }
  .btn-pri { background:#2563eb;color:#fff;border:none;padding:14px 32px;border-radius:12px;font-weight:700;cursor:pointer }
  .btn-sec { background:#f1f5f9;color:#475569;border:none;padding:14px 32px;border-radius:12px;font-weight:700;cursor:pointer }
  
  @media print { 
    body * { visibility: hidden; }
    #main_list, #main_list * { visibility: visible !important; }
    #main_list { position: absolute; left: 0; top: 0; width: 100%; border:none; box-shadow:none; }
    .no-print { display: none !important; }
    .printing-single #pv, .printing-single #pv * { visibility: visible !important; }
    .printing-single #pv { position: absolute; left:0; top:0; width:100%; background:white; }
    .printing-single #main_list { visibility: hidden !important; }
  }
</style>

<!--
..........................................................................................................
..........................................................................................................
.......... üìú JAVASCRIPT: SAYFA FONKSƒ∞YONLARI VE VERƒ∞ ƒ∞≈ûLEMLERƒ∞ ..........................................
..........................................................................................................
..........................................................................................................
-->

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/de.js"></script>

<script>
/* ================================
   EKSƒ∞K SINIF TANIMLARI (EK)
   DOKUNMADAN √áALI≈ûMASI ƒ∞√áƒ∞N
   ================================ */
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll('[id^="row-"]').forEach(row => {

    if (!row.querySelector('.t-monat') && row.querySelector('.t-raw-monat')) {
      const s = document.createElement('span');
      s.className = 't-monat';
      s.style.display = 'none';
      s.innerText = row.querySelector('.t-raw-monat').innerText;
      row.appendChild(s);
    }

    if (!row.querySelector('.t-ort')) {
      const visibleOrt = row.querySelector('td:nth-child(4)');
      if (visibleOrt) {
        const s = document.createElement('span');
        s.className = 't-ort';
        s.style.display = 'none';
        s.innerText = visibleOrt.innerText;
        row.appendChild(s);
      }
    }
  });
});

/* ================================
   FLATPICKR
   ================================ */
const fp = flatpickr(".date-picker", {
  locale: "de",
  dateFormat: "d.m.Y",
  allowInput: true
});

/* ================================
   TEKƒ∞L YAZDIR
   ================================ */
function printSingle() {
  document.body.classList.add('printing-single');
  window.print();
  document.body.classList.remove('printing-single');
}

/* ================================
   BEARBEITEN
   ================================ */
function editKunde(id) {
  const row = document.getElementById('row-' + id);

  document.getElementById('f_id').value = id;
  document.getElementById('f_firma').value = row.querySelector('.t-firma').innerText;
  document.getElementById('f_strasse').value = row.querySelector('.t-strasse').innerText;
  document.getElementById('f_plz').value = row.querySelector('.t-plz').innerText;
  document.getElementById('f_stadt').value = row.querySelector('.t-ort').innerText;
  document.getElementById('f_name').value = row.querySelector('.t-name').innerText;
  document.getElementById('f_tel').value = row.querySelector('.t-tel').innerText;
  document.getElementById('f_mail').value = row.querySelector('.t-mail').innerText;
  document.getElementById('f_knr').value = row.querySelector('.t-knr').innerText;
  document.getElementById('f_monat').value = row.querySelector('.t-raw-monat').innerText;
  document.getElementById('f_freq').value = row.querySelector('.t-freq').innerText;

  if (fp[0]) fp[0].setDate(row.querySelector('.t-beginn').innerText);
  if (fp[1]) fp[1].setDate(row.querySelector('.t-ende').innerText);

  // HERR / FRAU RADIO GERI YUKLE
  const fullName = row.querySelector('.t-name').innerText;
  document.querySelectorAll('input[name="anrede"]').forEach(r => {
    r.checked = false;
    if (fullName.startsWith(r.value + " ")) {
      r.checked = true;
    }
  });

  // VERTRAGSLAUFZEIT
  const laufzeit = row.querySelector('.t-laufzeit')?.innerText.trim().toLowerCase();
  document.querySelectorAll('input[name="laufzeit"]').forEach(r => {
    r.checked = (r.value === laufzeit);
  });

  // VERTRAGSSTATUS
  const status = row.querySelector('.t-status')?.innerText.trim().toLowerCase();
  document.querySelectorAll('input[name="status"]').forEach(r => {
    r.checked = (r.value === status);
  });

  document.getElementById('modalTitle').innerText = "Kunde bearbeiten";
  document.getElementById('km').style.display = 'flex';
}

/* ================================
   VORSCHAU
   ================================ */
function previewKunde(id) {
  const row = document.getElementById('row-' + id);
  document.getElementById('pv-firma').innerText = row.querySelector('.t-firma').innerText;
  document.getElementById('pv-details').innerHTML = `
    <strong>Kundennummer:</strong> ${row.querySelector('.t-knr').innerText}<br>
    <strong>Anschrift:</strong> ${row.querySelector('.t-strasse').innerText}, ${row.querySelector('.t-plz').innerText} ${row.querySelector('.t-ort').innerText}<br>
    <strong>Ansprechpartner:</strong> ${row.querySelector('.t-name').innerText}<br>
    <strong>Kontakt:</strong> ${row.querySelector('.t-tel').innerText} | ${row.querySelector('.t-mail').innerText}<br>
    <strong>Vertrag:</strong> ${row.querySelector('.t-beginn').innerText} bis ${row.querySelector('.t-ende').innerText}<br>
    <strong>Konditionen:</strong> ${row.querySelector('.t-monat').innerText} / ${row.querySelector('.t-freq').innerText}
  `;
  document.getElementById('pv').style.display = 'flex';
}

/* ================================
   NEUER KUNDE
   ================================ */
function openNewModal() {
  document.getElementById('f_id').value = "";
  document.getElementById('kundenForm').reset();
  document.getElementById('modalTitle').innerText = "Neuer Kunde";
  document.getElementById('km').style.display = 'flex';
}

/* ================================
   MODAL KAPAT
   ================================ */
function closeModal() {
  document.getElementById('km').style.display = 'none';
}

/* ================================
   PLZ ‚Üí STADT (NRW)
   ================================ */
function autoCityNRW() {
  const nrw = {
    '40':'D√ºsseldorf','41':'M√∂nchengladbach','42':'Wuppertal','44':'Dortmund',
    '45':'Essen','46':'Oberhausen','47':'Duisburg','48':'M√ºnster',
    '50':'K√∂ln','51':'Leverkusen','52':'Aachen','53':'Bonn',
    '57':'Siegen','58':'Hagen','59':'Hamm'
  };
  const v = document.getElementById('f_plz').value.substring(0, 2);
  document.getElementById('f_stadt').value =
    nrw[v] || (document.getElementById('f_plz').value.length > 2 ? "NRW Region" : "");
}
</script>
{% endblock %}
